<!DOCTYPE html>

<html lang="pl">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Quiz dla Przyjaciół! (Wersja Rozszerzona)</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>

        body {

            font-family: 'Inter', sans-serif;

        }

        .gradient-bg {

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

        }

        .card {

            background-color: rgba(255, 255, 255, 0.9);

            backdrop-filter: blur(10px);

        }

        .btn {

            transition: all 0.2s ease-in-out;

        }

        .btn:hover {

            transform: translateY(-2px);

            box-shadow: 0 4px 12px rgba(0,0,0,0.15);

        }

        .answer-btn.selected {

            background-color: #4f46e5;

            color: white;

            border-color: #4f46e5;

        }

        .answer-btn.correct {

            background-color: #22c55e;

            color: white;

            border-color: #22c55e;

        }

        .answer-btn.incorrect {

            background-color: #ef4444;

            color: white;

            border-color: #ef4444;

        }

    </style>

</head>

<body class="gradient-bg min-h-screen flex items-center justify-center p-4">



    <div id="app" class="w-full max-w-2xl mx-auto">



        <!-- Ekran logowania -->

        <div id="login-screen" class="card rounded-2xl p-8 shadow-2xl text-center">

            <h1 class="text-4xl font-bold text-gray-800 mb-2">Quiz dla Przyjaciół!</h1>

            <p class="text-gray-600 mb-6">Dołącz do gry i sprawdź swoją wiedzę.</p>

            <div class="space-y-4">

                <input type="text" id="player-name" placeholder="Wpisz swoje imię" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">

                <input type="text" id="quiz-id-input" placeholder="Wpisz ID quizu (jeśli dołączasz)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">

            </div>

            <div class="mt-6 flex flex-col sm:flex-row gap-4 justify-center">

                <button id="create-quiz-btn" class="btn w-full sm:w-auto bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700">Stwórz nowy quiz</button>

                <button id="join-quiz-btn" class="btn w-full sm:w-auto bg-green-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-600">Dołącz do quizu</button>

            </div>

            <p id="error-message" class="text-red-500 mt-4 h-5"></p>

        </div>



        <!-- Poczekalnia -->

        <div id="lobby-screen" class="hidden card rounded-2xl p-8 shadow-2xl text-center">

            <h2 class="text-3xl font-bold text-gray-800 mb-4">Poczekalnia</h2>

            <p class="text-gray-600 mb-2">ID Twojego quizu (podaj znajomym):</p>

            <div class="flex items-center justify-center gap-2 mb-6">

                <p id="quiz-id-display" class="text-2xl font-mono bg-gray-200 text-gray-800 px-4 py-2 rounded-lg"></p>

                <button id="copy-id-btn" class="btn bg-gray-300 p-2 rounded-lg hover:bg-gray-400">

                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>

                </button>

            </div>

            <p class="text-gray-600 mb-4">Czekamy na resztę graczy...</p>

            <div id="player-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-center">

                <!-- Lista graczy pojawi się tutaj -->

            </div>

            <div id="host-controls" class="hidden mt-8">

                <button id="start-quiz-btn" class="btn w-full bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-indigo-700 text-xl">Start!</button>

            </div>

             <p class="text-sm text-gray-500 mt-4">Twórca quizu rozpoczyna grę.</p>

        </div>



        <!-- Ekran quizu -->

        <div id="quiz-screen" class="hidden card rounded-2xl p-8 shadow-2xl">

            <div class="flex justify-between items-center mb-4">

                <div id="question-counter" class="text-lg font-semibold text-gray-700">Pytanie 1 / 25</div>

                <div id="timer" class="text-2xl font-bold text-indigo-600"></div>

            </div>

            <div class="bg-gray-200 h-2 rounded-full mb-6">

                <div id="progress-bar" class="bg-indigo-500 h-2 rounded-full" style="width: 0%;"></div>

            </div>

            <h2 id="question-text" class="text-2xl md:text-3xl font-bold text-gray-800 mb-8 text-center min-h-[100px]">Ładowanie pytania...</h2>

            <div id="answer-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <!-- Opcje odpowiedzi pojawią się tutaj -->

            </div>

            <div id="next-question-container" class="text-center mt-8 hidden">

                 <button id="next-question-btn" class="btn bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700">Następne pytanie</button>

            </div>

        </div>

        

        <!-- Ekran wyników i rankingu -->

        <div id="scoreboard-screen" class="hidden card rounded-2xl p-8 shadow-2xl">

             <h2 id="scoreboard-title" class="text-3xl font-bold text-gray-800 mb-6 text-center">Ranking</h2>

             <div id="scoreboard" class="space-y-3">

                 <!-- Wyniki pojawią się tutaj -->

             </div>

             <div id="final-results-controls" class="hidden text-center mt-8">

                <button id="play-again-btn" class="btn bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700">Zagraj jeszcze raz</button>

             </div>

        </div>



    </div>



    <script type="module">

        // Importy Firebase

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";



        // --- KONFIGURACJA ---

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'friends-quiz-app';



        // Inicjalizacja Firebase

        const app = initializeApp(firebaseConfig);

        const auth = getAuth(app);

        const db = getFirestore(app);



        // --- BAZA PYTAŃ ---

        const allQuestions = [

            // Kategoria: Friends

            { question: "Jak nazywał się pingwin-przytulanka Joey'ego?", options: ["Huggsy", "Waddles", "Snowy", "Flipper"], answer: "Huggsy" },

            { question: "Jakie jest drugie imię Chandlera?", options: ["Muriel", "Marcel", "Bing", "Eustace"], answer: "Muriel" },

            { question: "Ile sióstr ma Joey?", options: ["5", "6", "7", "8"], answer: "7" },

            { question: "Jak ma na imię siostra bliźniaczka Phoebe?", options: ["Ursula", "Regina", "Fiona", "Leslie"], answer: "Ursula" },

            { question: "Jaki był pies Ross'a i Moniki z dzieciństwa?", options: ["Bobo", "LaPooh", "Chi-Chi", "Patches"], answer: "Chi-Chi" },

            { question: "Kim z zawodu jest Ross?", options: ["Archeologiem", "Geologiem", "Antropologiem", "Paleontologiem"], answer: "Paleontologiem" },

            { question: "Kto mówi słynne 'Oh. My. God.'?", options: ["Janice", "Gunther", "Carol", "Estelle"], answer: "Janice" },

            // Kategoria: Formuła 1

            { question: "Który kierowca zdobył najwięcej tytułów Mistrza Świata (razem z M. Schumacherem)?", options: ["Ayrton Senna", "Lewis Hamilton", "Sebastian Vettel", "Alain Prost"], answer: "Lewis Hamilton" },

            { question: "Jak nazywany jest tor Monza we Włoszech?", options: ["Świątynia Prędkości", "Zielone Piekło", "Magiczny Tor", "Arena Mistrzów"], answer: "Świątynia Prędkości" },

            { question: "W jakim zespole jeździ Max Verstappen?", options: ["Mercedes", "Ferrari", "McLaren", "Red Bull Racing"], answer: "Red Bull Racing" },

            { question: "Ile punktów otrzymuje kierowca za zwycięstwo w Grand Prix?", options: ["20", "25", "30", "18"], answer: "25" },

            { question: "Z jakiego kraju pochodzi zespół Ferrari?", options: ["Niemcy", "Wielka Brytania", "Włochy", "Francja"], answer: "Włochy" },

            { question: "Co oznacza czarno-biała flaga w szachownicę w F1?", options: ["Kara", "Ostrzeżenie", "Koniec wyścigu", "Awaria bolidu"], answer: "Koniec wyścigu" },

            // Kategoria: Polska

            { question: "Jaki jest najwyższy szczyt w Polsce?", options: ["Giewont", "Śnieżka", "Rysy", "Babia Góra"], answer: "Rysy" },

            { question: "Które polskie miasto słynie z pierników?", options: ["Kraków", "Gdańsk", "Poznań", "Toruń"], answer: "Toruń" },

            { question: "Kto był pierwszym koronowanym królem Polski?", options: ["Mieszko I", "Bolesław I Chrobry", "Kazimierz Wielki", "Władysław Jagiełło"], answer: "Bolesław I Chrobry" },

            { question: "Jaka jest najdłuższa rzeka w Polsce?", options: ["Odra", "Warta", "Bug", "Wisła"], answer: "Wisła" },

            { question: "Który polski kompozytor słynie z polonezów i mazurków?", options: ["Stanisław Moniuszko", "Henryk Wieniawski", "Fryderyk Chopin", "Ignacy Jan Paderewski"], answer: "Fryderyk Chopin" },

             // Kategoria: Z naszych rozmów

            { question: "Kto zaproponował nagrywanie spotkania i transkrypcję AI?", options: ["Błażej", "Marta", "Ewelka", "Kuras"], answer: "Ewelka" },

            { question: "Na którą godzinę Błażej ustawił spotkanie?", options: ["21:00", "21:15", "20:30", "21:30"], answer: "21:15" },

            { question: "Kto jako pierwszy podał swojego maila w rozmowie?", options: ["Kuras", "Błażej", "Marta Kędzierska Kurasinska", "Ewelka"], answer: "Marta Kędzierska Kurasinska" },

            { question: "Jaki program do rysowania został wspomniany w rozmowie?", options: ["Photoshop", "Miro", "Figma", "Canva"], answer: "Figma" },

            { question: "Co Błażej zrobił z zebranymi mailami?", options: ["Wysłał zaproszenie", "Zapisał w notatkach", "Dodał do opisu grupy", "Wydrukował"], answer: "Dodał do opisu grupy" },

            { question: "Kto zapytał 'Evelka, a chcesz jechać ? xD'?", options: ["Kuras", "Błażej", "Kuba", "Marta"], answer: "Błażej" },

            { question: "Co według Marty trzeba by zrobić z rowerem, żeby zmieściła się Ewelka?", options: ["Sprzedać go", "Złożyć go", "Pomalować go", "Zostawić w domu"], answer: "Złożyć go" },

        ];



        // Funkcja do tasowania tablicy (algorytm Fisher-Yates)

        const shuffleArray = (array) => {

            for (let i = array.length - 1; i > 0; i--) {

                const j = Math.floor(Math.random() * (i + 1));

                [array[i], array[j]] = [array[j], array[i]];

            }

            return array;

        };

        

        const questions = shuffleArray([...allQuestions]);



        // --- ZMIENNE STANU APLIKACJI ---

        let currentUser = null;

        let currentQuizId = null;

        let isHost = false;

        let unsubscribeQuiz = null; 



        // --- ELEMENTY DOM ---

        const loginScreen = document.getElementById('login-screen');

        const lobbyScreen = document.getElementById('lobby-screen');

        const quizScreen = document.getElementById('quiz-screen');

        const scoreboardScreen = document.getElementById('scoreboard-screen');

        const errorMessage = document.getElementById('error-message');



        // --- FUNKCJE POMOCNICZE ---

        const showScreen = (screen) => {

            [loginScreen, lobbyScreen, quizScreen, scoreboardScreen].forEach(s => s.classList.add('hidden'));

            screen.classList.remove('hidden');

        };



        const setError = (message) => {

            errorMessage.textContent = message;

            setTimeout(() => errorMessage.textContent = '', 3000);

        };

        

        const getQuizRef = (quizId) => {

            return doc(db, "artifacts", appId, "public/data/quizzes", quizId);

        };



        // --- LOGIKA QUIZU ---



        document.getElementById('create-quiz-btn').addEventListener('click', async () => {

            const playerName = document.getElementById('player-name').value.trim();

            if (!playerName) {

                setError("Musisz podać swoje imię!");

                return;

            }



            isHost = true;

            const newQuizId = Math.random().toString(36).substring(2, 8).toUpperCase();

            currentQuizId = newQuizId;



            const quizData = {

                hostId: currentUser.uid,

                status: 'lobby',

                currentQuestionIndex: -1,

                players: {

                    [currentUser.uid]: { name: playerName, score: 0, answer: null }

                },

                createdAt: new Date(),

                questions: questions // Zapisujemy potasowaną listę pytań

            };



            try {

                await setDoc(getQuizRef(newQuizId), quizData);

                joinLobby(newQuizId);

            } catch (error) {

                console.error("Błąd tworzenia quizu:", error);

                setError("Nie udało się stworzyć quizu. Spróbuj ponownie.");

            }

        });



        document.getElementById('join-quiz-btn').addEventListener('click', async () => {

            const playerName = document.getElementById('player-name').value.trim();

            const quizId = document.getElementById('quiz-id-input').value.trim().toUpperCase();



            if (!playerName || !quizId) {

                setError("Musisz podać imię oraz ID quizu!");

                return;

            }



            try {

                const quizRef = getQuizRef(quizId);

                const quizSnap = await getDoc(quizRef);



                if (!quizSnap.exists()) {

                    setError("Quiz o podanym ID nie istnieje.");

                    return;

                }



                const quizData = quizSnap.data();

                if (quizData.status !== 'lobby') {

                    setError("Nie można dołączyć do quizu, który już się rozpoczął lub zakończył.");

                    return;

                }



                await updateDoc(quizRef, {

                    [`players.${currentUser.uid}`]: { name: playerName, score: 0, answer: null }

                });

                

                currentQuizId = quizId;

                isHost = (quizData.hostId === currentUser.uid);

                joinLobby(quizId);



            } catch (error) {

                console.error("Błąd dołączania do quizu:", error);

                setError("Nie udało się dołączyć do quizu. Sprawdź ID i spróbuj ponownie.");

            }

        });



        const joinLobby = (quizId) => {

            showScreen(lobbyScreen);

            document.getElementById('quiz-id-display').textContent = quizId;

            

            if (isHost) {

                document.getElementById('host-controls').classList.remove('hidden');

            }



            if (unsubscribeQuiz) unsubscribeQuiz();

            unsubscribeQuiz = onSnapshot(getQuizRef(quizId), (doc) => {

                const quizData = doc.data();

                if (!quizData) {

                    alert("Quiz został zakończony przez hosta.");

                    resetApp();

                    return;

                }

                updateUI(quizData);

            });

        };

        

        document.getElementById('copy-id-btn').addEventListener('click', () => {

            const quizId = document.getElementById('quiz-id-display').textContent;

            const textArea = document.createElement("textarea");

            textArea.value = quizId;

            document.body.appendChild(textArea);

            textArea.select();

            try {

                document.execCommand('copy');

                alert('Skopiowano ID quizu!');

            } catch (err) {

                console.error('Nie udało się skopiować ID: ', err);

                alert('Nie udało się skopiować ID.');

            }

            document.body.removeChild(textArea);

        });



        const updateUI = (quizData) => {

            const playerList = document.getElementById('player-list');

            playerList.innerHTML = '';

            Object.values(quizData.players).forEach(player => {

                const playerDiv = document.createElement('div');

                playerDiv.className = "bg-gray-100 p-4 rounded-lg shadow";

                playerDiv.innerHTML = `<div class="font-bold text-lg text-gray-800">${player.name}</div>`;

                playerList.appendChild(playerDiv);

            });

            

            if (quizData.status === 'in-progress') {

                showScreen(quizScreen);

                renderQuestion(quizData);

            } else if (quizData.status === 'scoreboard') {

                showScreen(scoreboardScreen);

                renderScoreboard(quizData, false);

            } else if (quizData.status === 'finished') {

                showScreen(scoreboardScreen);

                renderScoreboard(quizData, true);

            }

        };



        document.getElementById('start-quiz-btn').addEventListener('click', async () => {

            try {

                await updateDoc(getQuizRef(currentQuizId), {

                    status: 'in-progress',

                    currentQuestionIndex: 0

                });

            } catch (error) {

                console.error("Błąd rozpoczynania quizu:", error);

            }

        });



        const renderQuestion = (quizData) => {

            const questionIndex = quizData.currentQuestionIndex;

            const currentQuestions = quizData.questions; // Używamy pytań zapisanych w dokumencie

            if (questionIndex < 0 || questionIndex >= currentQuestions.length) return;

            

            const question = currentQuestions[questionIndex];

            

            document.getElementById('question-counter').textContent = `Pytanie ${questionIndex + 1} / ${currentQuestions.length}`;

            document.getElementById('progress-bar').style.width = `${((questionIndex + 1) / currentQuestions.length) * 100}%`;

            document.getElementById('question-text').textContent = question.question;



            const answerOptionsContainer = document.getElementById('answer-options');

            answerOptionsContainer.innerHTML = '';

            

            const myAnswer = quizData.players[currentUser.uid].answer;

            const allAnswered = Object.values(quizData.players).every(p => p.answer !== null);



            question.options.forEach(option => {

                const button = document.createElement('button');

                button.textContent = option;

                button.className = 'answer-btn btn p-4 border-2 border-gray-300 rounded-lg text-lg hover:bg-gray-100';

                

                if (myAnswer === null) {

                    button.onclick = () => submitAnswer(option);

                } else {

                    button.disabled = true;

                    if (option === myAnswer) button.classList.add('selected');

                    if (allAnswered) {

                        if (option === question.answer) {

                            button.classList.add('correct');

                        } else if (option === myAnswer) {

                            button.classList.add('incorrect');

                        }

                    }

                }

                answerOptionsContainer.appendChild(button);

            });



            const nextBtnContainer = document.getElementById('next-question-container');

            if (isHost && allAnswered) {

                nextBtnContainer.classList.remove('hidden');

            } else {

                nextBtnContainer.classList.add('hidden');

            }

        };



        const submitAnswer = async (answer) => {

            try {

                const quizRef = getQuizRef(currentQuizId);

                const quizSnap = await getDoc(quizRef);

                const quizData = quizSnap.data();



                const question = quizData.questions[quizData.currentQuestionIndex];

                let scoreUpdate = 0;

                if (answer === question.answer) {

                    scoreUpdate = 10;

                }



                await updateDoc(quizRef, {

                    [`players.${currentUser.uid}.answer`]: answer,

                    [`players.${currentUser.uid}.score`]: quizData.players[currentUser.uid].score + scoreUpdate

                });



            } catch (error) {

                console.error("Błąd przesyłania odpowiedzi:", error);

            }

        };

        

        document.getElementById('next-question-btn').addEventListener('click', async () => {

            try {

                const quizRef = getQuizRef(currentQuizId);

                const quizSnap = await getDoc(quizRef);

                const quizData = quizSnap.data();



                const nextIndex = quizData.currentQuestionIndex + 1;

                

                const playersWithResetAnswers = { ...quizData.players };

                Object.keys(playersWithResetAnswers).forEach(uid => {

                    playersWithResetAnswers[uid].answer = null;

                });



                if (nextIndex < quizData.questions.length) {

                    await updateDoc(quizRef, {

                        currentQuestionIndex: nextIndex,

                        players: playersWithResetAnswers,

                        status: 'in-progress'

                    });

                } else {

                    await updateDoc(quizRef, {

                        status: 'finished'

                    });

                }

            } catch (error) {

                console.error("Błąd przechodzenia do następnego pytania:", error);

            }

        });

        

        const renderScoreboard = (quizData, isFinal) => {

            const scoreboardContainer = document.getElementById('scoreboard');

            scoreboardContainer.innerHTML = '';

            

            const playersArray = Object.values(quizData.players);

            playersArray.sort((a, b) => b.score - a.score);

            

            document.getElementById('scoreboard-title').textContent = isFinal ? "Wyniki końcowe!" : "Ranking";



            playersArray.forEach((player, index) => {

                const rankDiv = document.createElement('div');

                rankDiv.className = 'flex items-center justify-between p-4 rounded-lg shadow';

                

                let medal = '';

                if (isFinal) {

                    if (index === 0) medal = '🥇';

                    if (index === 1) medal = '🥈';

                    if (index === 2) medal = '🥉';

                }

                

                rankDiv.innerHTML = `

                    <div class="flex items-center">

                        <span class="text-2xl font-bold w-10">${medal || (index + 1) + '.'}</span>

                        <span class="text-xl font-semibold text-gray-800">${player.name}</span>

                    </div>

                    <span class="text-2xl font-bold text-indigo-600">${player.score} pkt</span>

                `;

                

                if (isFinal && index === 0) { rankDiv.classList.add('bg-yellow-100'); }

                else if (isFinal && index === 1) { rankDiv.classList.add('bg-gray-200'); }

                else if (isFinal && index === 2) { rankDiv.classList.add('bg-orange-100'); }

                else { rankDiv.classList.add('bg-white'); }

                

                scoreboardContainer.appendChild(rankDiv);

            });



            const finalControls = document.getElementById('final-results-controls');

            if (isFinal && isHost) {

                finalControls.classList.remove('hidden');

            } else {

                finalControls.classList.add('hidden');

            }

        };

        

        const resetApp = () => {

            if (unsubscribeQuiz) unsubscribeQuiz();

            

            if (isHost && currentQuizId) {

                deleteDoc(getQuizRef(currentQuizId)).catch(err => console.error("Nie udało się usunąć quizu:", err));

            }

            

            currentQuizId = null;

            isHost = false;

            unsubscribeQuiz = null;

            

            document.getElementById('player-name').value = '';

            document.getElementById('quiz-id-input').value = '';

            

            showScreen(loginScreen);

        };

        

        document.getElementById('play-again-btn').addEventListener('click', resetApp);



        // --- AUTENTYKACJA ---

        onAuthStateChanged(auth, user => {

            if (user) {

                currentUser = user;

                console.log("Zalogowano anonimowo, UID:", user.uid);

            }

        });



        const authenticate = async () => {

            try {

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {

                    await signInWithCustomToken(auth, __initial_auth_token);

                } else {

                    await signInAnonymously(auth);

                }

            } catch (error) {

                console.error("Błąd autentykacji:", error);

                setError("Wystąpił problem z połączeniem. Odśwież stronę.");

            }

        };



        authenticate();



    </script>

</body>

</html>
