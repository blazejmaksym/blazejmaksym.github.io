<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz dla Przyjaciół! (Wersja Rozszerzona)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .answer-btn.selected {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .answer-btn.correct {
            background-color: #22c55e;
            color: white;
            border-color: #22c55e;
        }
        .answer-btn.incorrect {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-2xl mx-auto">
        <div id="login-screen" class="card rounded-2xl p-8 shadow-2xl text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Quiz dla Przyjaciół!</h1>
            <p class="text-gray-600 mb-6">Dołącz do gry i sprawdź swoją wiedzę.</p>
            <div class="space-y-4">
                <input type="text" id="player-name" placeholder="Wpisz swoje imię" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <input type="text" id="quiz-id-input" placeholder="Wpisz ID quizu (jeśli dołączasz)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-4 justify-center">
                <button id="create-quiz-btn" class="btn w-full sm:w-auto bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700">Stwórz nowy quiz</button>
                <button id="join-quiz-btn" class="btn w-full sm:w-auto bg-green-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-600">Dołącz do quizu</button>
            </div>
            <p id="error-message" class="text-red-500 mt-4 h-5"></p>
        </div>

        <div id="lobby-screen" class="hidden card rounded-2xl p-8 shadow-2xl text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Poczekalnia</h2>
            <p class="text-gray-600 mb-2">ID Twojego quizu (podaj znajomym):</p>
            <div class="flex items-center justify-center gap-2 mb-6">
                <p id="quiz-id-display" class="text-2xl font-mono bg-gray-200 text-gray-800 px-4 py-2 rounded-lg"></p>
                <button id="copy-id-btn" class="btn bg-gray-300 p-2 rounded-lg hover:bg-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                </button>
            </div>
            <p class="text-gray-600 mb-4">Czekamy na resztę graczy...</p>
            <div id="player-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-center">
                </div>
            <div id="host-controls" class="hidden mt-8">
                <button id="start-quiz-btn" class="btn w-full bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-indigo-700 text-xl">Start!</button>
            </div>
            <p class="text-sm text-gray-500 mt-4">Twórca quizu rozpoczyna grę.</p>
        </div>

        <div id="quiz-screen" class="hidden card rounded-2xl p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <div id="question-counter" class="text-lg font-semibold text-gray-700">Pytanie 1 / 25</div>
                <div id="timer" class="text-2xl font-bold text-indigo-600"></div>
            </div>
            <div class="bg-gray-200 h-2 rounded-full mb-6">
                <div id="progress-bar" class="bg-indigo-500 h-2 rounded-full" style="width: 0%;"></div>
            </div>
            <h2 id="question-text" class="text-2xl md:text-3xl font-bold text-gray-800 mb-8 text-center min-h-[100px]">Ładowanie pytania...</h2>
            <div id="answer-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
            <div id="next-question-container" class="text-center mt-8 hidden">
                <button id="next-question-btn" class="btn bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700">Następne pytanie</button>
            </div>
        </div>

        <div id="scoreboard-screen" class="hidden card rounded-2xl p-8 shadow-2xl">
            <h2 id="scoreboard-title" class="text-3xl font-bold text-gray-800 mb-6 text-center">Ranking</h2>
            <div id="scoreboard" class="space-y-3">
                </div>
            <div id="final-results-controls" class="hidden text-center mt-8">
                <button id="play-again-btn" class="btn bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700">Zagraj jeszcze raz</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importy Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURACJA ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = 'friends-quiz-app';

        // Inicjalizacja Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- BAZA PYTAŃ ---
        const allQuestions = [
            // Kategoria: Friends
            { question: "Jak nazywał się pingwin-przytulanka Joey'ego?", options: ["Huggsy", "Waddles", "Snowy", "Flipper"], answer: "Huggsy" },
            { question: "Jakie jest drugie imię Chandlera?", options: ["Muriel", "Marcel", "Bing", "Eustace"], answer: "Muriel" },
            { question: "Ile sióstr ma Joey?", options: ["5", "6", "7", "8"], answer: "7" },
            { question: "Jak ma na imię siostra bliźniaczka Phoebe?", options: ["Ursula", "Regina", "Fiona", "Leslie"], answer: "Ursula" },
            { question: "Jaki był pies Ross'a i Moniki z dzieciństwa?", options: ["Bobo", "LaPooh", "Chi-Chi", "Patches"], answer: "Chi-Chi" },
            { question: "Kim z zawodu jest Ross?", options: ["Archeologiem", "Geologiem", "Antropologiem", "Paleontologiem"], answer: "Paleontologiem" },
            { question: "Kto mówi słynne 'Oh. My. God.'?", options: ["Janice", "Gunther", "Carol", "Estelle"], answer: "Janice" },
            // Kategoria: Formuła 1
            { question: "Który kierowca zdobył najwięcej tytułów Mistrza Świata (razem z M. Schumacherem)?", options: ["Ayrton Senna", "Lewis Hamilton", "Sebastian Vettel", "Alain Prost"], answer: "Lewis Hamilton" },
            { question: "Jak nazywany jest tor Monza we Włoszech?", options: ["Świątynia Prędkości", "Zielone Piekło", "Magiczny Tor", "Arena Mistrzów"], answer: "Świątynia Prędkości" },
            { question: "W jakim zespole jeździ Max Verstappen?", options: ["Mercedes", "Ferrari", "McLaren", "Red Bull Racing"], answer: "Red Bull Racing" },
            { question: "Ile punktów otrzymuje kierowca za zwycięstwo w Grand Prix?", options: ["20", "25", "30", "18"], answer: "25" },
            { question: "Z jakiego kraju pochodzi zespół Ferrari?", options: ["Niemcy", "Wielka Brytania", "Włochy", "Francja"], answer: "Włochy" },
            { question: "Co oznacza czarno-biała flaga w szachownicę w F1?", options: ["Kara", "Ostrzeżenie", "Koniec wyścigu", "Awaria bolidu"], answer: "Koniec wyścigu" },
            // Kategoria: Polska
            { question: "Jaki jest najwyższy szczyt w Polsce?", options: ["Giewont", "Śnieżka", "Rysy", "Babia Góra"], answer: "Rysy" },
            { question: "Które polskie miasto słynie z pierników?", options: ["Kraków", "Gdańsk", "Poznań", "Toruń"], answer: "Toruń" },
            { question: "Kto był pierwszym koronowanym królem Polski?", options: ["Mieszko I", "Bolesław I Chrobry", "Kazimierz Wielki", "Władysław Jagiełło"], answer: "Bolesław I Chrobry" },
            { question: "Jaka jest najdłuższa rzeka w Polsce?", options: ["Odra", "Warta", "Bug", "Wisła"], answer: "Wisła" },
            { question: "Który polski kompozytor słynie z polonezów i mazurków?", options: ["Stanisław Moniuszko", "Henryk Wieniawski", "Fryderyk Chopin", "Ignacy Jan Paderewski"], answer: "Fryderyk Chopin" },
            // Kategoria: Z naszych rozmów
            { question: "Kto zaproponował nagrywanie spotkania i transkrypcję AI?", options: ["Błażej", "Marta", "Ewelka", "Kuras"], answer: "Ewelka" },
            { question: "Na którą godzinę Błażej ustawił spotkanie?", options: ["21:00", "21:15", "20:30", "21:30"], answer: "21:15" },
            { question: "Kto jako pierwszy podał swojego maila w rozmowie?", options: ["Kuras", "Błażej", "Marta Kędzierska Kurasinska", "Ewelka"], answer: "Marta Kędzierska Kurasinska" },
            { question: "Jaki program do rysowania został wspomniony w rozmowie?", options: ["Photoshop", "Miro", "Figma", "Canva"], answer: "Figma" },
            { question: "Co Błażej zrobił z zebranymi mailami?", options: ["Wysłał zaproszenie", "Zapisał w notatkach", "Dodał do opisu grupy", "Wydrukował"], answer: "Dodał do opisu grupy" },
            { question: "Kto zapytał 'Evelka, a chcesz jechać ? xD'?", options: ["Kuras", "Błażej", "Kuba", "Marta"], answer: "Błażej" },
            { question: "Co według Marty trzeba by zrobić z rowerem, żeby zmieściła się Ewelka?", options: ["Sprzedać go", "Złożyć go", "Pomalować go", "Zostawić w domu"], answer: "Złożyć go" },
        ];

        // Funkcja do tasowania tablicy (algorytm Fisher-Yates)
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };
        const questions = shuffleArray([...allQuestions]);

        // --- ZMIENNE STANU APLIKACJI ---
        let currentUser = null;
        let currentQuizId = null;
        let isHost = false;
        let unsubscribeQuiz = null;
        let currentQuestionIndex = 0;
        let currentScore = 0;
        let isAnswered = false;

        // --- ELEMENTY DOM ---
        const loginScreen = document.getElementById('login-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const scoreboardScreen = document.getElementById('scoreboard-screen');
        const errorMessage = document.getElementById('error-message');
        const playerNameInput = document.getElementById('player-name');
        const quizIdInput = document.getElementById('quiz-id-input');
        const createQuizBtn = document.getElementById('create-quiz-btn');
        const joinQuizBtn = document.getElementById('join-quiz-btn');
        const quizIdDisplay = document.getElementById('quiz-id-display');
        const copyIdBtn = document.getElementById('copy-id-btn');
        const playerList = document.getElementById('player-list');
        const hostControls = document.getElementById('host-controls');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const questionCounter = document.getElementById('question-counter');
        const timerElement = document.getElementById('timer');
        const progressBar = document.getElementById('progress-bar');
        const questionText = document.getElementById('question-text');
        const answerOptionsContainer = document.getElementById('answer-options');
        const nextQuestionContainer = document.getElementById('next-question-container');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const scoreboard = document.getElementById('scoreboard');
        const scoreboardTitle = document.getElementById('scoreboard-title');
        const playAgainBtn = document.getElementById('play-again-btn');

        // --- FUNKCJE POMOCNICZE ---
        const showScreen = (screen) => {
            [loginScreen, lobbyScreen, quizScreen, scoreboardScreen].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
        };

        const setError = (message) => {
            errorMessage.textContent = message;
            setTimeout(() => errorMessage.textContent = '', 3000);
        };

        const getQuizRef = (quizId) => {
            return doc(db, "artifacts", appId, "public/data/quizzes", quizId);
        };

        const updatePlayerList = (players) => {
            playerList.innerHTML = '';
            Object.values(players).forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.textContent = player.name;
                playerEl.className = 'bg-gray-100 p-3 rounded-lg font-semibold';
                playerList.appendChild(playerEl);
            });
        };

        const displayQuestion = (questionData) => {
            isAnswered = false;
            questionText.textContent = questionData.question;
            answerOptionsContainer.innerHTML = '';
            questionData.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'answer-btn btn w-full p-4 rounded-lg bg-white shadow-sm text-gray-800 font-semibold text-left border border-transparent hover:border-indigo-500';
                button.addEventListener('click', () => handleAnswer(option, questionData.answer, button));
                answerOptionsContainer.appendChild(button);
            });
            nextQuestionContainer.classList.add('hidden');
        };

        const handleAnswer = async (selectedAnswer, correctAnswer, button) => {
            if (isAnswered) return;
            isAnswered = true;
            
            const quizRef = getQuizRef(currentQuizId);
            const quizSnap = await getDoc(quizRef);
            const quizData = quizSnap.data();

            const isCorrect = selectedAnswer === correctAnswer;

            if (isCorrect) {
                currentScore += 1;
                button.classList.add('correct');
            } else {
                button.classList.add('incorrect');
                const correctButton = Array.from(answerOptionsContainer.children).find(btn => btn.textContent === correctAnswer);
                if (correctButton) {
                    correctButton.classList.add('correct');
                }
            }
            
            // Highlight the selected answer
            button.classList.add('selected');

            // Update player's score in the database
            const players = quizData.players;
            players[currentUser.uid].score = currentScore;
            await updateDoc(quizRef, { players });

            // Allow moving to the next question
            if (isHost) {
                nextQuestionContainer.classList.remove('hidden');
            }
        };

        // --- LOGIKA QUIZU ---

        document.getElementById('create-quiz-btn').addEventListener('click', async () => {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                setError("Musisz podać swoje imię!");
                return;
            }
            isHost = true;
            const newQuizId = Math.random().toString(36).substring(2, 8).toUpperCase();
            currentQuizId = newQuizId;

            await signInAnonymously(auth);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const quizData = {
                        hostId: currentUser.uid,
                        questions: questions,
                        currentQuestionIndex: 0,
                        state: 'lobby', // 'lobby', 'quiz', 'scoreboard'
                        players: {
                            [currentUser.uid]: {
                                name: playerName,
                                score: 0
                            }
                        }
                    };
                    const quizRef = getQuizRef(currentQuizId);
                    await setDoc(quizRef, quizData);
                    document.getElementById('quiz-id-display').textContent = newQuizId;
                    showScreen(lobbyScreen);
                    hostControls.classList.remove('hidden');
                    startListeningToQuiz();
                }
            });
        });

        document.getElementById('join-quiz-btn').addEventListener('click', async () => {
            const playerName = playerNameInput.value.trim();
            const quizId = quizIdInput.value.trim().toUpperCase();
            if (!playerName || !quizId) {
                setError("Musisz podać swoje imię i ID quizu!");
                return;
            }

            const quizRef = getQuizRef(quizId);
            const quizSnap = await getDoc(quizRef);

            if (!quizSnap.exists()) {
                setError("Quiz o takim ID nie istnieje!");
                return;
            }

            currentQuizId = quizId;
            await signInAnonymously(auth);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const quizData = quizSnap.data();
                    if (quizData.players && quizData.players[currentUser.uid]) {
                        // Player already exists, do nothing
                    } else {
                        const players = quizData.players || {};
                        players[currentUser.uid] = { name: playerName, score: 0 };
                        await updateDoc(quizRef, { players });
                    }
                    document.getElementById('quiz-id-display').textContent = quizId;
                    showScreen(lobbyScreen);
                    startListeningToQuiz();
                }
            });
        });

        startQuizBtn.addEventListener('click', async () => {
            if (!isHost) return;
            const quizRef = getQuizRef(currentQuizId);
            await updateDoc(quizRef, { state: 'quiz' });
        });
        
        nextQuestionBtn.addEventListener('click', async () => {
            if (!isHost) return;
            const quizRef = getQuizRef(currentQuizId);
            const quizSnap = await getDoc(quizRef);
            const quizData = quizSnap.data();
            const nextIndex = quizData.currentQuestionIndex + 1;

            if (nextIndex < quizData.questions.length) {
                await updateDoc(quizRef, {
                    currentQuestionIndex: nextIndex
                });
            } else {
                await updateDoc(quizRef, { state: 'scoreboard' });
            }
        });

        playAgainBtn.addEventListener('click', () => {
            window.location.reload();
        });

        // --- ZARZĄDZANIE STANEM QUIZU W CZASIE RZECZYWISTYM ---

        const startListeningToQuiz = () => {
            const quizRef = getQuizRef(currentQuizId);
            if (unsubscribeQuiz) {
                unsubscribeQuiz();
            }
            unsubscribeQuiz = onSnapshot(quizRef, (docSnap) => {
                const quizData = docSnap.data();
                if (!quizData) return;

                if (isHost) {
                    // Host-specific logic
                }
                
                switch (quizData.state) {
                    case 'lobby':
                        showScreen(lobbyScreen);
                        updatePlayerList(quizData.players);
                        break;
                    case 'quiz':
                        showScreen(quizScreen);
                        updatePlayerList(quizData.players);
                        
                        currentQuestionIndex = quizData.currentQuestionIndex;
                        questionCounter.textContent = `Pytanie ${currentQuestionIndex + 1} / ${quizData.questions.length}`;
                        const currentQuestion = quizData.questions[currentQuestionIndex];
                        displayQuestion(currentQuestion);
                        break;
                    case 'scoreboard':
                        showScreen(scoreboardScreen);
                        displayScoreboard(quizData.players);
                        break;
                }
            });
        };

        const displayScoreboard = (players) => {
            scoreboard.innerHTML = '';
            const sortedPlayers = Object.values(players).sort((a, b) => b.score - a.score);
            sortedPlayers.forEach((player, index) => {
                const playerEl = document.createElement('div');
                playerEl.className = 'flex justify-between items-center bg-gray-100 p-4 rounded-lg shadow-sm';
                playerEl.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-bold text-lg mr-2">${index + 1}.</span>
                        <span class="text-xl font-semibold">${player.name}</span>
                    </div>
                    <span class="text-xl font-bold text-indigo-600">${player.score}</span>
                `;
                scoreboard.appendChild(playerEl);
            });

            if (isHost) {
                document.getElementById('final-results-controls').classList.remove('hidden');
            }
        };

    </script>
</body>
</html>
